<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ­ã‚·ã‚¢èªå˜èªå¸³</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .card { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:6px; }
    .row { margin:8px 0; }
    #drop { border:1px dashed #aaa; padding:8px; border-radius:6px; margin-top:6px; }
  </style>
</head>
<body>
  <h1>ãƒ­ã‚·ã‚¢èªå˜èªå¸³</h1>

  <!-- CSV æ“ä½œç”¨ -->
  <div class="row">
    <input type="file" id="csv" accept=".csv">
    <button id="btnFetchCsv">åŒæ¢±CSVã‚’èª­ã‚€</button>
    <div id="drop">CSVã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</div>
  </div>

  <!-- å˜èªè¡¨ç¤º -->
  <div class="card">
    <div id="ru" style="font-size:2em;font-weight:bold;"></div>
    <div id="jp" style="color:#555;"></div>
  </div>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="row">
    <button id="prev">â—€ å‰ã¸</button>
    <button id="next">æ¬¡ã¸ â–¶</button>
    <button id="speak">ğŸ”Š èª­ã¿ä¸Šã’</button>
  </div>

  <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
  <div class="row">
    <label>é€Ÿåº¦: <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1"></label>
    <label>å£°ã®é«˜ã•: <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1"></label>
  </div>

  <!-- ãŠæ°—ã«å…¥ã‚Š -->
  <div class="row">
    <button id="fav">â­ ãŠæ°—ã«å…¥ã‚Šè¿½åŠ </button>
    <div id="favList"></div>
  </div>

<script>
let data = [];   // {ru, jp}
let idx = 0;
let favorites = [];

/* ---- CSVå‡¦ç† ---- */
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }
async function parseCsvText(text){
  return new Promise(res=>{
    Papa.parse(text, {header:true, skipEmptyLines:true, complete:r=>res(
      r.data.map(x=>({ru:norm(x.ru), jp:norm(x.jp)})).filter(x=>x.ru&&x.jp)
    )});
  });
}

document.getElementById('csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});

const drop = document.getElementById('drop');
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#f7f7f7'; });
drop.addEventListener('dragleave', ()=> drop.style.background='');
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.style.background='';
  const f = e.dataTransfer.files[0]; if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});

document.getElementById('btnFetchCsv').onclick = async ()=>{
  try{
    const resp = await fetch('./words.csv', {cache:'no-store'});
    if(!resp.ok) throw new Error(resp.status);
    const txt = await resp.text();
    const rows = await parseCsvText(txt);
    if(rows.length) loadData(rows, txt);
  }catch(e){ alert('words.csv ã‚’èª­ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }
};

function loadData(rows, raw){
  data = rows; idx=0;
  localStorage.setItem('lastCsv', raw);
  renderList(); show(0);
}

/* èµ·å‹•æ™‚ã«å‰å›CSVã‚’å¾©å…ƒ */
(async ()=>{
  const txt = localStorage.getItem('lastCsv');
  if(txt){
    const rows = await parseCsvText(txt);
    if(rows.length) { data=rows; show(0); renderList(); }
  }
})();

/* ---- å˜èªè¡¨ç¤º ---- */
function show(i){
  if(!data.length) return;
  idx = (i+data.length)%data.length;
  document.getElementById('ru').textContent = data[idx].ru;
  document.getElementById('jp').textContent = data[idx].jp;
}
document.getElementById('prev').onclick = ()=>show(idx-1);
document.getElementById('next').onclick = ()=>show(idx+1);

/* ---- èª­ã¿ä¸Šã’ ---- */
document.getElementById('speak').onclick = ()=>{
  if(!data.length) return;
  const u = new SpeechSynthesisUtterance(data[idx].ru);
  u.lang='ru-RU';
  u.rate = parseFloat(document.getElementById('rate').value);
  u.pitch= parseFloat(document.getElementById('pitch').value);
  speechSynthesis.cancel(); speechSynthesis.speak(u);
};

/* ---- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒªã‚»ãƒƒãƒˆ ---- */
function dblReset(el, def){
  let last=0;
  el.addEventListener('click',()=>{
    const now=Date.now();
    if(now-last<400){ el.value=def; }
    last=now;
  });
}
dblReset(document.getElementById('rate'), 1);
dblReset(document.getElementById('pitch'), 1);

/* ---- ãŠæ°—ã«å…¥ã‚Š ---- */
document.getElementById('fav').onclick=()=>{
  if(!data.length) return;
  const w = data[idx];
  if(!favorites.find(x=>x.ru===w.ru)){ favorites.push(w); renderFav(); }
};
function renderFav(){
  const box=document.getElementById('favList');
  box.innerHTML = favorites.map(w=>`<div>${w.ru} - ${w.jp}</div>`).join('');
}
function renderList(){ /* å°†æ¥æ‹¡å¼µç”¨ */ }
// ====== TTS å®‰å®šåŒ–ï¼ˆiOSå¯¾å¿œï¼‰ ======
let ruVoice=null, jaVoice=null, ttsReady=false;

function pickVoices(){
  const vs = speechSynthesis.getVoices();
  ruVoice = vs.find(v=>/ru/i.test(v.lang) || /Russian/i.test(v.name)) || null;
  jaVoice = vs.find(v=>/ja/i.test(v.lang) || /Japanese/i.test(v.name)) || null;
}
if ('speechSynthesis' in window) {
  pickVoices();
  speechSynthesis.onvoiceschanged = pickVoices;
}

// åˆå›ã‚¿ãƒƒãƒ—ã§è§£æ”¾ï¼ˆå¿…é ˆï¼‰
document.addEventListener('click', function unlockOnce(){
  // ç„¡éŸ³ã§èµ·ã“ã™
  const u = new SpeechSynthesisUtterance(' ');
  u.lang = 'ru-RU';
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
  ttsReady = true;
  document.removeEventListener('click', unlockOnce);
},{once:true});

// æ­£è¦åŒ–
function norm(t){
  return (t||'').toString()
    .replace(/\uFEFF/g,'')
    .normalize('NFC')
    .trim();
}

// ãƒ­ã‚·ã‚¢èªèª­ã¿ä¸Šã’
function speakRUText(text){
  const s = norm(text);
  if (!ttsReady || !s || !/[^\s!?.,:;()ã€Œã€ã€ã€]/.test(s)) return; // æ–‡å­—ãªã—ãªã‚‰èª­ã¾ãªã„
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(s);
  u.lang = 'ru-RU';
  if (ruVoice) u.voice = ruVoice;
  u.rate = parseFloat(document.getElementById('rate').value || 1);
  u.pitch= parseFloat(document.getElementById('pitch').value || 1);
  speechSynthesis.speak(u);
}

// æ—¥æœ¬èªèª­ã¿ä¸Šã’ï¼ˆä»»æ„ï¼‰
function speakJPText(text){
  const s = norm(text);
  if (!ttsReady || !s) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(s);
  u.lang = 'ja-JP';
  if (jaVoice) u.voice = jaVoice;
  u.rate = 1.0; u.pitch = 1.0;
  speechSynthesis.speak(u);
}

// ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã¨æ—¢å­˜ãƒœã‚¿ãƒ³ã«æ¥ç¶š
document.getElementById('btnTest').onclick = ()=> speakRUText('ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, ĞºĞ°Ğº Ğ´ĞµĞ»Ğ°?');
document.getElementById('speakRu').onclick = ()=> speakRUText(document.getElementById('ru').textContent);
document.getElementById('speakJp').onclick = ()=> speakJPText(document.getElementById('jp').textContent);

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºæ›´æ–°ï¼ˆåŠ¹ã„ã¦ãªã„å•é¡Œã®å¯è¦–åŒ–ï¼‰
const rateEl = document.getElementById('rate'), pitchEl = document.getElementById('pitch');
const rateVal = document.getElementById('rateVal') || (()=>{const s=document.createElement('span');s.id='rateVal';rateEl.parentNode.appendChild(s);return s;})();
const pitchVal= document.getElementById('pitchVal')|| (()=>{const s=document.createElement('span');s.id='pitchVal';pitchEl.parentNode.appendChild(s);return s;})();
function updVals(){ rateVal.textContent = Number(rateEl.value).toFixed(2); pitchVal.textContent = ' ' + Number(pitchEl.value).toFixed(2); }
rateEl.addEventListener('input',updVals); pitchEl.addEventListener('input',updVals); updVals();
</script>
<script>
/* ===== è¨ºæ–­UI ===== */
const logBox = (() => {
  const d = document.createElement('div');
  d.id = 'diag'; d.style.cssText = 'white-space:pre-wrap;font:12px/1.4 monospace;background:#f7f7f7;padding:8px;border:1px solid #ddd;margin-top:8px';
  document.body.appendChild(d);
  return d;
})();
function log(s){ logBox.textContent += s + '\n'; }

/* ===== çŠ¶æ…‹ ===== */
let ruVoice=null, jaVoice=null, ttsReady=false;

/* ===== Voices å–å¾— ===== */
function pickVoices(){
  const vs = speechSynthesis.getVoices();
  log(`voices: ${vs.length}`);
  ruVoice = vs.find(v=>/ru/i.test(v.lang) || /russian/i.test(v.name)) || null;
  jaVoice = vs.find(v=>/ja/i.test(v.lang) || /japanese/i.test(v.name)) || null;
  log(`ruVoice: ${ruVoice? (ruVoice.name+' '+ruVoice.lang) : 'NONE'}`);
  log(`jaVoice: ${jaVoice? (jaVoice.name+' '+jaVoice.lang) : 'NONE'}`);
}
if ('speechSynthesis' in window) {
  pickVoices();
  speechSynthesis.onvoiceschanged = () => { log('onvoiceschanged'); pickVoices(); };
} else {
  log('speechSynthesis NOT available');
}

/* ===== åˆå›ã‚¯ãƒªãƒƒã‚¯ã§è§£æ”¾ï¼ˆiOSå¿…é ˆï¼‰ ===== */
document.addEventListener('click', function unlockOnce(){
  const u = new SpeechSynthesisUtterance(' ');
  u.lang = 'ru-RU';
  speechSynthesis.speak(u);
  ttsReady = true;
  log('TTS unlocked by user click');
  document.removeEventListener('click', unlockOnce);
},{once:true});

/* ===== æ­£è¦åŒ– ===== */
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }

/* ===== èª­ã¿ä¸Šã’ ===== */
function speak(text, lang, voice) {
  const s = norm(text);
  if (!ttsReady) { log('speak blocked: not unlocked'); return; }
  if (!s) { log('speak blocked: empty'); return; }
  // iOSã§ãŸã¾ã« cancel ãŒé€†åŠ¹æœã€‚ã¾ãšã¯ç„¡ã—ã§è©¦ã™ã€‚å¿…è¦ãªã‚‰ä¸‹ã®1è¡Œã‚’æœ‰åŠ¹åŒ–ã€‚
  // speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(s);
  u.lang = lang;
  if (voice) u.voice = voice; // ãªãã¦ã‚‚OKã€‚langã ã‘ã§è¡Œã‘ã‚‹ç«¯æœ«å¤šã„ã€‚
  const rateEl = document.getElementById('rate'); const pitchEl = document.getElementById('pitch');
  u.rate  = rateEl ? parseFloat(rateEl.value)||1.0  : 1.0;
  u.pitch = pitchEl? parseFloat(pitchEl.value)||1.0 : 1.0;
  log(`speak: "${s}" lang=${lang} rate=${u.rate} pitch=${u.pitch} voice=${voice?voice.name:'(none)'}`);
  speechSynthesis.speak(u);
}

/* ===== æ—¢å­˜UIã«æ¥ç¶šï¼ˆIDã¯æ—¢å­˜ã®ã¾ã¾æƒ³å®šï¼‰ ===== */
const btnTest = document.getElementById('btnTest');
if (btnTest) btnTest.onclick = () => speak('ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, ĞºĞ°Ğº Ğ´ĞµĞ»Ğ°?', 'ru-RU', ruVoice);

const btnRu = document.getElementById('speakRu');
if (btnRu) btnRu.onclick = () => speak(document.getElementById('ru').textContent, 'ru-RU', ruVoice);

const btnJp = document.getElementById('speakJp');
if (btnJp) btnJp.onclick = () => speak(document.getElementById('jp').textContent, 'ja-JP', jaVoice);

/* ===== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºç¢ºèª ===== */
['rate','pitch'].forEach(id=>{
  const el = document.getElementById(id);
  const val = document.getElementById(id+'Val') || (()=>{const s=document.createElement('span');s.id=id+'Val';el?.parentNode?.appendChild(s);return s;})();
  function upd(){ val.textContent = ' ' + Number(el.value).toFixed(2); }
  if (el){ el.addEventListener('input', upd); upd(); }
});

/* ===== ãƒ†ã‚¹ãƒˆ: ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®voicesçŠ¶æ³ ===== */
window.addEventListener('load', ()=> log('page loaded'));
</script>
</body>
</html>