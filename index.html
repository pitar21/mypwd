<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãƒ­ã‚·ã‚¢èªå˜èªå¸³ PWAãƒ†ã‚¹ãƒˆ</title>
<style>
  body{font-family:system-ui, -apple-system, Arial; margin:16px;}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  #ru{font-size:28px;margin:12px 0}
  #jp{color:#666;margin:4px 0 12px}
  button{padding:8px 12px}
  input[type=range]{width:180px}
  ul{list-style:none;padding:0}
  li{padding:6px 8px;border-bottom:1px solid #eee;cursor:pointer}
  .fav{color:#e39}
</style>
<h1>ğŸ“– ãƒ­ã‚·ã‚¢èªå˜èªå¸³</h1>

<div class="row">
  <input type="file" id="csv" accept=".csv">
  <button id="btnTest">RU test</button>
  <label>é€Ÿåº¦ <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1.0"><span id="rateVal">1.00</span></label>
</div>

<div id="ru">â€”</div>
<div id="jp">â€”</div>

<div class="row">
  <button id="speakRu">ğŸ”Š RU</button>
  <button id="speakJp">ğŸ”Š JP</button>
  <button id="next">æ¬¡ã¸</button>
  <button id="fav">â˜†ãŠæ°—ã«å…¥ã‚Š</button>
  <button id="togglePool">Favã®ã¿:OFF</button>
</div>

<ul id="list"></ul>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/* ====== çŠ¶æ…‹ ====== */
let data = [
  {ru:'Ğ´Ğ°', jp:'ã¯ã„'},
  {ru:'Ğ½ĞµÑ‚', jp:'ã„ã„ãˆ'},
  {ru:'ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾', jp:'ã‚ã‚ŠãŒã¨ã†'},
  {ru:'Ğ²Ğ¾Ğ´Ğ°', jp:'æ°´'},
  {ru:'Ñ…Ğ»ĞµĞ±', jp:'ãƒ‘ãƒ³'}
];
let idx = 0;
let ruVoice = null, jaVoice = null;
let rate = 1.0;
let favs = new Set(JSON.parse(localStorage.getItem('favs') || '[]'));
let favOnly = false;

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const $ = s => document.querySelector(s);
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }
function keyOf(o){ return `${o.ru}\t${o.jp}`; }
function pool(){ return favOnly ? data.filter(o=>favs.has(keyOf(o))) || data : data; }
function show(i){
  const p = pool(); if(!p.length){ $('#ru').textContent='ãƒ‡ãƒ¼ã‚¿ãªã—'; $('#jp').textContent='csvã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'; return; }
  const item = p[(i%p.length+p.length)%p.length];
  idx = p.indexOf(item);
  $('#ru').textContent = item.ru;
  $('#jp').textContent = item.jp;
  $('#fav').textContent = favs.has(keyOf(item)) ? 'â˜…ãŠæ°—ã«å…¥ã‚Š' : 'â˜†ãŠæ°—ã«å…¥ã‚Š';
}

/* ====== Voices é…å»¶å–å¾—å¯¾å¿œ ====== */
function pickVoices(){
  const voices = speechSynthesis.getVoices();
  ruVoice = voices.find(v=>/ru/i.test(v.lang)) || voices.find(v=>/ru/i.test(v.name)) || null;
  jaVoice = voices.find(v=>/ja/i.test(v.lang)) || voices.find(v=>/ja/i.test(v.name)) || null;
}
if('speechSynthesis' in window){
  pickVoices();
  speechSynthesis.onvoiceschanged = pickVoices;
}

/* ====== TTS ====== */
function speak(text, lang, voice){
  const t = norm(text);
  if(!t) return;
  speechSynthesis.cancel(); // iOSè©°ã¾ã‚Šå›é¿
  const u = new SpeechSynthesisUtterance(t);
  u.lang = lang;
  if(voice) u.voice = voice;
  u.rate = rate; // 0.7â€“1.3 æ¨å¥¨
  speechSynthesis.speak(u);
}
function speakRU(){ speak($('#ru').textContent, 'ru-RU', ruVoice); }
function speakJP(){ speak($('#jp').textContent, 'ja-JP', jaVoice); }

/* ====== åˆå›ã‚¿ãƒƒãƒ—ã§éŸ³å£°è§£æ”¾ï¼ˆiOSå¿…é ˆï¼‰ ====== */
document.addEventListener('click', function unlockOnce(){
  // ç©ºèª­ã¿ä¸Šã’ã§æ¨©é™ã‚’â€œèµ·ã“ã™â€
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(' ');
  u.lang = 'ru-RU'; speechSynthesis.speak(u);
  document.removeEventListener('click', unlockOnce);
}, {once:true});

/* ====== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ====== */
$('#rate').addEventListener('input', e=>{
  rate = parseFloat(e.target.value);
  $('#rateVal').textContent = rate.toFixed(2);
});

/* ====== ãƒœã‚¿ãƒ³ ====== */
$('#btnTest').onclick = ()=> speak('ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, ĞºĞ°Ğº Ğ´ĞµĞ»Ğ°?', 'ru-RU', ruVoice);
$('#speakRu').onclick = speakRU;
$('#speakJp').onclick = speakJP;
$('#next').onclick = ()=> show(idx+1);
$('#fav').onclick = ()=>{
  const item = {ru:$('#ru').textContent, jp:$('#jp').textContent};
  const k = keyOf(item);
  if(favs.has(k)) favs.delete(k); else favs.add(k);
  localStorage.setItem('favs', JSON.stringify([...favs]));
  $('#fav').textContent = favs.has(k) ? 'â˜…ãŠæ°—ã«å…¥ã‚Š' : 'â˜†ãŠæ°—ã«å…¥ã‚Š';
};
$('#togglePool').onclick = ()=>{
  favOnly = !favOnly;
  $('#togglePool').textContent = favOnly ? 'Favã®ã¿:ON' : 'Favã®ã¿:OFF';
  show(0);
};

/* ====== CSVèª­è¾¼ï¼ˆãƒ˜ãƒƒãƒ€: ru,jpï¼‰ ====== */
$('#csv').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  Papa.parse(file, {
    header: true,
    encoding: 'UTF-8',
    skipEmptyLines: true,
    complete: res=>{
      const rows = res.data.map(r=>({ru:norm(r.ru), jp:norm(r.jp)}))
                           .filter(r=>r.ru && r.jp);
      if(rows.length){ data = rows; idx = 0; renderList(); show(0); }
    }
  });
});

/* ====== ä¸€è¦§ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠâ†’RUèª­ã¿ä¸Šã’ï¼‰ ====== */
function renderList(){
  const ul = $('#list'); ul.innerHTML='';
  pool().forEach((o,i)=>{
    const li = document.createElement('li');
    li.innerHTML = `<span>${o.ru}</span>ã€€<span style="color:#666">${o.jp}</span> ` +
      (favs.has(keyOf(o)) ? '<span class="fav">â˜…</span>' : '');
    li.onclick = ()=>{ idx=i; show(i); speakRU(); };
    ul.appendChild(li);
  });
}
<!-- æœ«å°¾ã®<script>å†…ã«è¿½è¨˜ or ç½®æ›ï¼ˆPapaParseã¯èª­ã¿è¾¼ã¿æ¸ˆã¿æƒ³å®šï¼‰ -->
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }

async function parseCsvText(text){
  return new Promise(res=>{
    Papa.parse(text, {header:true, skipEmptyLines:true, complete:r=>res(
      r.data.map(x=>({ru:norm(x.ru), jp:norm(x.jp)})).filter(x=>x.ru&&x.jp)
    )});
  });
}

/* 1) input=file */
document.getElementById('csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length){ data=rows; idx=0; renderList(); show(0); localStorage.setItem('lastCsv', txt); }
});

/* 2) ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
const drop = document.getElementById('drop');
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#f7f7f7'; });
drop.addEventListener('dragleave', ()=> drop.style.background='');
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.style.background='';
  const f = e.dataTransfer.files[0];
  if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length){ data=rows; idx=0; renderList(); show(0); localStorage.setItem('lastCsv', txt); }
});

/* 3) ã‚µã‚¤ãƒˆåŒæ¢±CSVã‚’fetchï¼ˆä¾‹: åŒã˜éšå±¤ã« words.csv ã‚’ç½®ãï¼‰ */
document.getElementById('btnFetchCsv').onclick = async ()=>{
  try{
    const resp = await fetch('./words.csv', {cache:'no-store'});
    if(!resp.ok) throw new Error(resp.status);
    const txt = await resp.text();
    const rows = await parseCsvText(txt);
    if(rows.length){ data=rows; idx=0; renderList(); show(0); localStorage.setItem('lastCsv', txt); }
  }catch(e){ alert('words.csv ã‚’èª­ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }
};

/* èµ·å‹•æ™‚ã«å‰å›CSVã‚’å¾©å…ƒï¼ˆä»»æ„ï¼‰ */
(async ()=>{
  const txt = localStorage.getItem('lastCsv');
  if(txt){
    const rows = await parseCsvText(txt);
    if(rows.length){ data=rows; idx=0; renderList(); show(0); }
  }
})();

/* åˆæœŸè¡¨ç¤º */
renderList(); show(0);
</script>