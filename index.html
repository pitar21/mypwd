<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ­ã‚·ã‚¢èªå˜èªå¸³</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Arial;margin:16px}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .card{border:1px solid #ddd;border-radius:8px;padding:12px;margin:8px 0}
  #ru{font-size:28px;font-weight:700}
  #jp{color:#666;margin-top:6px}
  button{padding:8px 12px}
  input[type=range]{width:160px}
  select{padding:6px}
  .ok{color:#0a0}
  .ng{color:#c00}
  .muted{color:#999}
</style>
</head>
<body>
<h1>ğŸ“– ãƒ­ã‚·ã‚¢èªå˜èªå¸³</h1>

<!-- CSV æ“ä½œ -->
<div class="row">
  <input type="file" id="csv" accept=".csv">
  <button id="btnFetchCsv">åŒæ¢±CSVã‚’èª­ã‚€</button>
  <div id="drop" style="border:1px dashed #aaa;padding:8px;border-radius:6px">CSVã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ‰ãƒ»éŸ³å£° -->
<div class="row">
  <label><input type="checkbox" id="rand"> ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ</label>
  <button id="togglePool">Favã®ã¿:OFF</button>
  <span class="muted">ï½œ RU Voice:</span>
  <select id="ruVoiceSel"><option>loadingâ€¦</option></select>
  <span class="muted">JA Voice:</span>
  <select id="jaVoiceSel"><option>loadingâ€¦</option></select>
</div>

<!-- è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ -->
<div class="card">
  <div id="ru">â€”</div>
  <div id="jp">â€”</div>
</div>

<!-- æ“ä½œ -->
<div class="row">
  <button id="prev">â—€ å‰ã¸</button>
  <button id="next">æ¬¡ã¸ â–¶</button>
  <button id="speakRu">ğŸ”Š RU</button>
  <button id="speakJp">ğŸ”Š JP</button>
  <button id="fav">â˜†ãŠæ°—ã«å…¥ã‚Š</button>
</div>

<!-- TTS ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
<div class="row">
  <label>é€Ÿåº¦ <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1.0"><span id="rateVal">1.00</span></label>
  <label>ãƒ”ãƒƒãƒ <input id="pitch" type="range" min="0.5" max="2.0" step="0.05" value="1.00"><span id="pitchVal">1.00</span></label>
</div>

<!-- å­¦ç¿’é€²æ— -->
<div class="row">
  <span id="progress" class="muted">é€²æ—: 0/0ï¼ˆæ­£ç­” 0ï¼‰</span>
  <button id="markKnown">âœ” å­¦ç¿’æ¸ˆã¿ã«ã™ã‚‹</button>
  <button id="resetStats">çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- ã‚¯ã‚¤ã‚ºï¼ˆJPâ†’RUå…¥åŠ›ï¼‰ -->
<div class="card">
  <div><b>ã‚¯ã‚¤ã‚º</b>ï¼ˆæ—¥æœ¬èªâ†’ãƒ­ã‚·ã‚¢èªï¼‰</div>
  <div class="muted" style="margin-top:4px">æ—¥æœ¬èªã‚’è¦‹ã¦ãƒ­ã‚·ã‚¢èªã‚’å…¥åŠ› â†’ åˆ¤å®š</div>
  <div id="quizJp" style="margin-top:8px;font-size:18px">â€”</div>
  <div class="row">
    <input id="quizAns" type="text" placeholder="ã“ã“ã«RUã‚’å…¥åŠ›" style="flex:1;min-width:200px;padding:8px">
    <button id="quizCheck">åˆ¤å®š</button>
    <button id="quizShow">ç­”ãˆã‚’è¦‹ã‚‹</button>
    <button id="quizNext">æ¬¡ã®å•é¡Œ</button>
  </div>
  <div id="quizMsg" class="muted">â€”</div>
</div>

<script>
/* ====== çŠ¶æ…‹ ====== */
let data = [{ru:'Ğ´Ğ°',jp:'ã¯ã„'},{ru:'Ğ½ĞµÑ‚',jp:'ã„ã„ãˆ'},{ru:'ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾',jp:'ã‚ã‚ŠãŒã¨ã†'}];
let idx = 0;
let favs = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));
let favOnly = false;
let randMode = false;

let ruVoice = null, jaVoice = null, ttsReady = false;
let voicesCache = [];
let stats = JSON.parse(localStorage.getItem('stats')||'{}'); // key: "ru\tjp" -> {seen,correct}

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const $ = s => document.querySelector(s);
const keyOf = o => `${o.ru}\t${o.jp}`;
const norm = t => (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim();
const sample = arr => arr[(Math.random()*arr.length)|0];
function pool(){ const p = favOnly ? data.filter(o=>favs.has(keyOf(o))) : data; return p.length? p : data; }
function updateProgress(){
  const p = pool();
  const seen = p.reduce((a,o)=>a+(stats[keyOf(o)]?.seen||0),0);
  const ok = p.reduce((a,o)=>a+(stats[keyOf(o)]?.correct||0),0);
  $('#progress').textContent = `é€²æ—: ${p.length}/${data.length}ï¼ˆæ­£ç­” ${ok}ï¼‰`;
}

/* ====== è¡¨ç¤ºãƒ»ç§»å‹• ====== */
function show(i){
  const p = pool(); if(!p.length){ $('#ru').textContent='ãƒ‡ãƒ¼ã‚¿ãªã—'; $('#jp').textContent='CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'; return; }
  if (randMode) { idx = p.indexOf(sample(p)); }
  else { idx = (i%p.length+p.length)%p.length; }
  const w = p[idx];
  $('#ru').textContent = w.ru;
  $('#jp').textContent = w.jp;
  $('#fav').textContent = favs.has(keyOf(w)) ? 'â˜…ãŠæ°—ã«å…¥ã‚Š' : 'â˜†ãŠæ°—ã«å…¥ã‚Š';
  updateProgress();
  // ã‚¯ã‚¤ã‚ºå´ã‚‚åŒã˜å˜èªã§
  $('#quizJp').textContent = w.jp;
  $('#quizAns').value = '';
  $('#quizMsg').textContent = 'â€”';
}
$('#prev').onclick = ()=> show(idx-1);
$('#next').onclick = ()=> show(idx+1);

/* ====== ãŠæ°—ã«å…¥ã‚Š ====== */
$('#fav').onclick = ()=>{
  const w = {ru:$('#ru').textContent, jp:$('#jp').textContent};
  const k = keyOf(w);
  if (favs.has(k)) favs.delete(k); else favs.add(k);
  localStorage.setItem('favs', JSON.stringify([...favs]));
  $('#fav').textContent = favs.has(k) ? 'â˜…ãŠæ°—ã«å…¥ã‚Š' : 'â˜†ãŠæ°—ã«å…¥ã‚Š';
};
$('#togglePool').onclick = ()=>{
  favOnly = !favOnly;
  $('#togglePool').textContent = favOnly ? 'Favã®ã¿:ON' : 'Favã®ã¿:OFF';
  show(0);
};
$('#rand').onchange = e => { randMode = e.target.checked; };

/* ====== CSV èª­ã¿è¾¼ã¿ï¼ˆé¸æŠï¼D&Dï¼åŒæ¢±ï¼‰ ====== */
async function parseCsvText(text){
  return new Promise(res=>{
    Papa.parse(text,{header:true,skipEmptyLines:true,complete:r=>res(
      r.data.map(x=>({ru:norm(x.ru), jp:norm(x.jp)})).filter(x=>x.ru&&x.jp)
    )});
  });
}
$('#csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text(); const rows=await parseCsvText(txt);
  if(rows.length){ data=rows; idx=0; localStorage.setItem('lastCsv', txt); stats={}; localStorage.setItem('stats',JSON.stringify(stats)); show(0); }
});
const drop = $('#drop');
drop.addEventListener('dragover', e=>{e.preventDefault(); drop.style.background='#f7f7f7';});
drop.addEventListener('dragleave', ()=> drop.style.background='');
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.style.background='';
  const f=e.dataTransfer.files[0]; if(!f) return;
  const txt=await f.text(); const rows=await parseCsvText(txt);
  if(rows.length){ data=rows; idx=0; localStorage.setItem('lastCsv', txt); stats={}; localStorage.setItem('stats',JSON.stringify(stats)); show(0); }
});
$('#btnFetchCsv').onclick = async ()=>{
  try{
    const resp = await fetch('./words.csv',{cache:'no-store'});
    if(!resp.ok) throw new Error();
    const txt = await resp.text();
    const rows = await parseCsvText(txt);
    if(rows.length){ data=rows; idx=0; localStorage.setItem('lastCsv', txt); stats={}; localStorage.setItem('stats',JSON.stringify(stats)); show(0); }
  }catch{ alert('words.csv ã‚’èª­ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }
};
(async()=>{
  const txt=localStorage.getItem('lastCsv');
  if(txt){ const rows=await parseCsvText(txt); if(rows.length){ data=rows; show(0); } }
})();

/* ====== å­¦ç¿’é€²æ— ====== */
$('#markKnown').onclick = ()=>{
  const k = keyOf({ru:$('#ru').textContent, jp:$('#jp').textContent});
  stats[k] = stats[k] || {seen:0,correct:0};
  stats[k].seen++; stats[k].correct++;
  localStorage.setItem('stats', JSON.stringify(stats));
  updateProgress();
};
$('#resetStats').onclick = ()=>{ stats={}; localStorage.setItem('stats','{}'); updateProgress(); };

/* ====== ã‚¯ã‚¤ã‚ºï¼ˆJPâ†’RUï¼‰ ====== */
function currentWord(){ return {ru:$('#ru').textContent, jp:$('#jp').textContent}; }
$('#quizCheck').onclick = ()=>{
  const ans = norm($('#quizAns').value);
  const w = currentWord();
  const k = keyOf(w);
  stats[k] = stats[k] || {seen:0,correct:0};
  stats[k].seen++;
  if (ans === norm(w.ru)){
    stats[k].correct++;
    $('#quizMsg').innerHTML = '<span class="ok">æ­£è§£</span>';
    speakRUText(w.ru);
  }else{
    $('#quizMsg').innerHTML = `<span class="ng">ä¸æ­£è§£</span>ï¼ˆæ­£: ${w.ru}ï¼‰`;
  }
  localStorage.setItem('stats', JSON.stringify(stats));
  updateProgress();
};
$('#quizShow').onclick = ()=>{ const w=currentWord(); $('#quizMsg').innerHTML = `ç­”ãˆ: <b>${w.ru}</b>`; };
$('#quizNext').onclick = ()=> show(idx+1);

/* ====== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§æ—¢å®šã«æˆ»ã™ï¼‰ ====== */
function bindSlider(id, def, on){
  const el=$(id); const val=$(id+'Val');
  el.addEventListener('input', ()=> val.textContent = Number(el.value).toFixed(2));
  let last=0; el.addEventListener('click',()=>{ const now=Date.now(); if(now-last<400){ el.value=def; el.dispatchEvent(new Event('input')); } last=now; });
  el.value = def; el.dispatchEvent(new Event('input')); if(on) on(el);
}
bindSlider('#rate', 1.0);
bindSlider('#pitch',1.0);

/* ====== TTSï¼ˆéŸ³å£°é¸æŠï¼šYuriå„ªå…ˆï¼‰ ====== */
function populateVoiceSelects(){
  const vs = speechSynthesis.getVoices();
  voicesCache = vs;
  // RU
  const ruCandidates = vs.filter(v=>/ru/i.test(v.lang)||/russian/i.test(v.name));
  const ruSel = $('#ruVoiceSel'); ruSel.innerHTML='';
  ruCandidates.forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; ruSel.appendChild(o); });
  // Yuri ã‚’å„ªå…ˆé¸æŠï¼ˆç„¡ã‘ã‚Œã°æœ€åˆï¼‰
  const y = ruCandidates.find(v=>/yuri/i.test(v.name));
  ruSel.value = y ? y.name : (ruCandidates[0]?.name || '');
  ruVoice = vs.find(v=>v.name===ruSel.value) || null;

  // JA
  const jaCandidates = vs.filter(v=>/ja/i.test(v.lang)||/japanese/i.test(v.name));
  const jaSel = $('#jaVoiceSel'); jaSel.innerHTML='';
  jaCandidates.forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; jaSel.appendChild(o); });
  jaSel.value = jaCandidates[0]?.name || '';
  jaVoice = vs.find(v=>v.name===jaSel.value) || null;
}
if ('speechSynthesis' in window){
  populateVoiceSelects();
  speechSynthesis.onvoiceschanged = populateVoiceSelects;
}

$('#ruVoiceSel').onchange = e=>{ ruVoice = voicesCache.find(v=>v.name===e.target.value) || null; };
$('#jaVoiceSel').onchange = e=>{ jaVoice = voicesCache.find(v=>v.name===e.target.value) || null; };

// åˆå›ã‚¿ãƒƒãƒ—ã§TTSè§£æ”¾ï¼ˆiOSå¿…è¦ï¼‰
document.addEventListener('click', function unlockOnce(){
  const u=new SpeechSynthesisUtterance(' '); u.lang='ru-RU'; speechSynthesis.speak(u);
  ttsReady=true; document.removeEventListener('click', unlockOnce);
},{once:true});

/* ====== ç™ºè©± ====== */
function speakBase(text, lang, voice){
  const s = norm(text); if(!ttsReady || !s) return;
  const u = new SpeechSynthesisUtterance(s);
  u.lang = lang; if(voice) u.voice = voice;
  u.rate = parseFloat($('#rate').value)||1.0;
  u.pitch= parseFloat($('#pitch').value)||1.0;
  // cancelã¯ç«¯æœ«ã«ã‚ˆã‚Šé€†åŠ¹æœãªã“ã¨ãŒã‚ã‚‹ãŸã‚ç™ºè©±ç›´å‰ã¯è¡Œã‚ãªã„
  speechSynthesis.speak(u);
}
function speakRUText(t){ speakBase(t,'ru-RU',ruVoice); }
function speakJPText(t){ speakBase(t,'ja-JP',jaVoice); }
$('#speakRu').onclick = ()=> speakRUText($('#ru').textContent);
$('#speakJp').onclick = ()=> speakJPText($('#jp').textContent);

/* ====== åˆæœŸæç”» ====== */
show(0);
</script>
</body>
</html>