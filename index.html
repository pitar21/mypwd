<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ロシア語単語帳</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .card { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:6px; }
    .row { margin:8px 0; }
    #drop { border:1px dashed #aaa; padding:8px; border-radius:6px; margin-top:6px; }
  </style>
</head>
<body>
  <h1>ロシア語単語帳</h1>

  <!-- CSV 操作用 -->
  <div class="row">
    <input type="file" id="csv" accept=".csv">
    <button id="btnFetchCsv">同梱CSVを読む</button>
    <div id="drop">CSVをここにドロップ</div>
  </div>

  <!-- 単語表示 -->
  <div class="card">
    <div id="ru" style="font-size:2em;font-weight:bold;"></div>
    <div id="jp" style="color:#555;"></div>
  </div>

  <!-- 操作ボタン -->
  <div class="row">
    <button id="prev">◀ 前へ</button>
    <button id="next">次へ ▶</button>
    <button id="speak">🔊 読み上げ</button>
  </div>

  <!-- スライダー -->
  <div class="row">
    <label>速度: <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1"></label>
    <label>声の高さ: <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1"></label>
  </div>

  <!-- お気に入り -->
  <div class="row">
    <button id="fav">⭐ お気に入り追加</button>
    <div id="favList"></div>
  </div>

<script>
let data = [];   // {ru, jp}
let idx = 0;
let favorites = [];

/* ---- CSV処理 ---- */
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }
async function parseCsvText(text){
  return new Promise(res=>{
    Papa.parse(text, {header:true, skipEmptyLines:true, complete:r=>res(
      r.data.map(x=>({ru:norm(x.ru), jp:norm(x.jp)})).filter(x=>x.ru&&x.jp)
    )});
  });
}

document.getElementById('csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});

const drop = document.getElementById('drop');
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#f7f7f7'; });
drop.addEventListener('dragleave', ()=> drop.style.background='');
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.style.background='';
  const f = e.dataTransfer.files[0]; if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});

document.getElementById('btnFetchCsv').onclick = async ()=>{
  try{
    const resp = await fetch('./words.csv', {cache:'no-store'});
    if(!resp.ok) throw new Error(resp.status);
    const txt = await resp.text();
    const rows = await parseCsvText(txt);
    if(rows.length) loadData(rows, txt);
  }catch(e){ alert('words.csv を読めませんでした'); }
};

function loadData(rows, raw){
  data = rows; idx=0;
  localStorage.setItem('lastCsv', raw);
  renderList(); show(0);
}

/* 起動時に前回CSVを復元 */
(async ()=>{
  const txt = localStorage.getItem('lastCsv');
  if(txt){
    const rows = await parseCsvText(txt);
    if(rows.length) { data=rows; show(0); renderList(); }
  }
})();

/* ---- 単語表示 ---- */
function show(i){
  if(!data.length) return;
  idx = (i+data.length)%data.length;
  document.getElementById('ru').textContent = data[idx].ru;
  document.getElementById('jp').textContent = data[idx].jp;
}
document.getElementById('prev').onclick = ()=>show(idx-1);
document.getElementById('next').onclick = ()=>show(idx+1);

/* ---- 読み上げ ---- */
document.getElementById('speak').onclick = ()=>{
  if(!data.length) return;
  const u = new SpeechSynthesisUtterance(data[idx].ru);
  u.lang='ru-RU';
  u.rate = parseFloat(document.getElementById('rate').value);
  u.pitch= parseFloat(document.getElementById('pitch').value);
  speechSynthesis.cancel(); speechSynthesis.speak(u);
};

/* ---- スライダー ダブルタップでリセット ---- */
function dblReset(el, def){
  let last=0;
  el.addEventListener('click',()=>{
    const now=Date.now();
    if(now-last<400){ el.value=def; }
    last=now;
  });
}
dblReset(document.getElementById('rate'), 1);
dblReset(document.getElementById('pitch'), 1);

/* ---- お気に入り ---- */
document.getElementById('fav').onclick=()=>{
  if(!data.length) return;
  const w = data[idx];
  if(!favorites.find(x=>x.ru===w.ru)){ favorites.push(w); renderFav(); }
};
function renderFav(){
  const box=document.getElementById('favList');
  box.innerHTML = favorites.map(w=>`<div>${w.ru} - ${w.jp}</div>`).join('');
}
function renderList(){ /* 将来拡張用 */ }
// ====== TTS 安定化（iOS対応） ======
let ruVoice=null, jaVoice=null, ttsReady=false;

function pickVoices(){
  const vs = speechSynthesis.getVoices();
  ruVoice = vs.find(v=>/ru/i.test(v.lang) || /Russian/i.test(v.name)) || null;
  jaVoice = vs.find(v=>/ja/i.test(v.lang) || /Japanese/i.test(v.name)) || null;
}
if ('speechSynthesis' in window) {
  pickVoices();
  speechSynthesis.onvoiceschanged = pickVoices;
}

// 初回タップで解放（必須）
document.addEventListener('click', function unlockOnce(){
  // 無音で起こす
  const u = new SpeechSynthesisUtterance(' ');
  u.lang = 'ru-RU';
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
  ttsReady = true;
  document.removeEventListener('click', unlockOnce);
},{once:true});

// 正規化
function norm(t){
  return (t||'').toString()
    .replace(/\uFEFF/g,'')
    .normalize('NFC')
    .trim();
}

// ロシア語読み上げ
function speakRUText(text){
  const s = norm(text);
  if (!ttsReady || !s || !/[^\s!?.,:;()「」『』]/.test(s)) return; // 文字なしなら読まない
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(s);
  u.lang = 'ru-RU';
  if (ruVoice) u.voice = ruVoice;
  u.rate = parseFloat(document.getElementById('rate').value || 1);
  u.pitch= parseFloat(document.getElementById('pitch').value || 1);
  speechSynthesis.speak(u);
}

// 日本語読み上げ（任意）
function speakJPText(text){
  const s = norm(text);
  if (!ttsReady || !s) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(s);
  u.lang = 'ja-JP';
  if (jaVoice) u.voice = jaVoice;
  u.rate = 1.0; u.pitch = 1.0;
  speechSynthesis.speak(u);
}

// テストボタンと既存ボタンに接続
document.getElementById('btnTest').onclick = ()=> speakRUText('Привет, как дела?');
document.getElementById('speakRu').onclick = ()=> speakRUText(document.getElementById('ru').textContent);
document.getElementById('speakJp').onclick = ()=> speakJPText(document.getElementById('jp').textContent);

// スライダー表示更新（効いてない問題の可視化）
const rateEl = document.getElementById('rate'), pitchEl = document.getElementById('pitch');
const rateVal = document.getElementById('rateVal') || (()=>{const s=document.createElement('span');s.id='rateVal';rateEl.parentNode.appendChild(s);return s;})();
const pitchVal= document.getElementById('pitchVal')|| (()=>{const s=document.createElement('span');s.id='pitchVal';pitchEl.parentNode.appendChild(s);return s;})();
function updVals(){ rateVal.textContent = Number(rateEl.value).toFixed(2); pitchVal.textContent = ' ' + Number(pitchEl.value).toFixed(2); }
rateEl.addEventListener('input',updVals); pitchEl.addEventListener('input',updVals); updVals();
</script>
<script>
/* ===== 診断UI ===== */
const logBox = (() => {
  const d = document.createElement('div');
  d.id = 'diag'; d.style.cssText = 'white-space:pre-wrap;font:12px/1.4 monospace;background:#f7f7f7;padding:8px;border:1px solid #ddd;margin-top:8px';
  document.body.appendChild(d);
  return d;
})();
function log(s){ logBox.textContent += s + '\n'; }

/* ===== 状態 ===== */
let ruVoice=null, jaVoice=null, ttsReady=false;

/* ===== Voices 取得 ===== */
function pickVoices(){
  const vs = speechSynthesis.getVoices();
  log(`voices: ${vs.length}`);
  ruVoice = vs.find(v=>/ru/i.test(v.lang) || /russian/i.test(v.name)) || null;
  jaVoice = vs.find(v=>/ja/i.test(v.lang) || /japanese/i.test(v.name)) || null;
  log(`ruVoice: ${ruVoice? (ruVoice.name+' '+ruVoice.lang) : 'NONE'}`);
  log(`jaVoice: ${jaVoice? (jaVoice.name+' '+jaVoice.lang) : 'NONE'}`);
}
if ('speechSynthesis' in window) {
  pickVoices();
  speechSynthesis.onvoiceschanged = () => { log('onvoiceschanged'); pickVoices(); };
} else {
  log('speechSynthesis NOT available');
}

/* ===== 初回クリックで解放（iOS必須） ===== */
document.addEventListener('click', function unlockOnce(){
  const u = new SpeechSynthesisUtterance(' ');
  u.lang = 'ru-RU';
  speechSynthesis.speak(u);
  ttsReady = true;
  log('TTS unlocked by user click');
  document.removeEventListener('click', unlockOnce);
},{once:true});

/* ===== 正規化 ===== */
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }

/* ===== 読み上げ ===== */
function speak(text, lang, voice) {
  const s = norm(text);
  if (!ttsReady) { log('speak blocked: not unlocked'); return; }
  if (!s) { log('speak blocked: empty'); return; }
  // iOSでたまに cancel が逆効果。まずは無しで試す。必要なら下の1行を有効化。
  // speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(s);
  u.lang = lang;
  if (voice) u.voice = voice; // なくてもOK。langだけで行ける端末多い。
  const rateEl = document.getElementById('rate'); const pitchEl = document.getElementById('pitch');
  u.rate  = rateEl ? parseFloat(rateEl.value)||1.0  : 1.0;
  u.pitch = pitchEl? parseFloat(pitchEl.value)||1.0 : 1.0;
  log(`speak: "${s}" lang=${lang} rate=${u.rate} pitch=${u.pitch} voice=${voice?voice.name:'(none)'}`);
  speechSynthesis.speak(u);
}

/* ===== 既存UIに接続（IDは既存のまま想定） ===== */
const btnTest = document.getElementById('btnTest');
if (btnTest) btnTest.onclick = () => speak('Привет, как дела?', 'ru-RU', ruVoice);

const btnRu = document.getElementById('speakRu');
if (btnRu) btnRu.onclick = () => speak(document.getElementById('ru').textContent, 'ru-RU', ruVoice);

const btnJp = document.getElementById('speakJp');
if (btnJp) btnJp.onclick = () => speak(document.getElementById('jp').textContent, 'ja-JP', jaVoice);

/* ===== スライダー表示確認 ===== */
['rate','pitch'].forEach(id=>{
  const el = document.getElementById(id);
  const val = document.getElementById(id+'Val') || (()=>{const s=document.createElement('span');s.id=id+'Val';el?.parentNode?.appendChild(s);return s;})();
  function upd(){ val.textContent = ' ' + Number(el.value).toFixed(2); }
  if (el){ el.addEventListener('input', upd); upd(); }
});

/* ===== テスト: ページ表示時のvoices状況 ===== */
window.addEventListener('load', ()=> log('page loaded'));
</script>
</body>
</html>