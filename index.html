<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ロシア語単語帳</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .card { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:6px; }
    .row { margin:8px 0; }
    #drop { border:1px dashed #aaa; padding:8px; border-radius:6px; margin-top:6px; }
  </style>
</head>
<body>
  <h1>ロシア語単語帳</h1>

  <!-- CSV 操作用 -->
  <div class="row">
    <input type="file" id="csv" accept=".csv">
    <button id="btnFetchCsv">同梱CSVを読む</button>
    <div id="drop">CSVをここにドロップ</div>
  </div>

  <!-- 単語表示 -->
  <div class="card">
    <div id="ru" style="font-size:2em;font-weight:bold;"></div>
    <div id="jp" style="color:#555;"></div>
  </div>

  <!-- 操作ボタン -->
  <div class="row">
    <button id="prev">◀ 前へ</button>
    <button id="next">次へ ▶</button>
    <button id="speak">🔊 読み上げ</button>
  </div>

  <!-- スライダー -->
  <div class="row">
    <label>速度: <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1"></label>
    <label>声の高さ: <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1"></label>
  </div>

  <!-- お気に入り -->
  <div class="row">
    <button id="fav">⭐ お気に入り追加</button>
    <div id="favList"></div>
  </div>
<script>
/* ===== 状態 ===== */
let data = [], idx = 0, favorites = [];
let ruVoice=null, jaVoice=null, ttsReady=false;

/* ===== ユーティリティ ===== */
const $ = s => document.querySelector(s);
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }

/* ===== CSV処理 ===== */
async function parseCsvText(text){
  return new Promise(res=>{
    Papa.parse(text,{header:true,skipEmptyLines:true,complete:r=>res(
      r.data.map(x=>({ru:norm(x.ru), jp:norm(x.jp)})).filter(x=>x.ru&&x.jp)
    )});
  });
}
$('#csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text(); const rows=await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});
const drop=$('#drop');
drop.addEventListener('dragover', e=>{e.preventDefault(); drop.style.background='#f7f7f7';});
drop.addEventListener('dragleave', ()=> drop.style.background='');
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.style.background='';
  const f=e.dataTransfer.files[0]; if(!f) return;
  const txt=await f.text(); const rows=await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});
$('#btnFetchCsv').onclick=async()=>{
  try{
    const resp=await fetch('./words.csv',{cache:'no-store'}); if(!resp.ok) throw new Error();
    const txt=await resp.text(); const rows=await parseCsvText(txt);
    if(rows.length) loadData(rows, txt);
  }catch{ alert('words.csv を読めませんでした'); }
};
function loadData(rows, raw){
  data=rows; idx=0; localStorage.setItem('lastCsv', raw);
  renderFav(); show(0);
}
(async()=>{
  const txt=localStorage.getItem('lastCsv');
  if(txt){ const rows=await parseCsvText(txt); if(rows.length){ data=rows; show(0); } }
})();

/* ===== 表示 ===== */
function show(i){
  if(!data.length) return;
  idx=(i+data.length)%data.length;
  $('#ru').textContent=data[idx].ru;
  $('#jp').textContent=data[idx].jp;
}
$('#prev').onclick=()=>show(idx-1);
$('#next').onclick=()=>show(idx+1);

/* ===== お気に入り ===== */
$('#fav').onclick=()=>{
  if(!data.length) return;
  const w=data[idx];
  if(!favorites.find(x=>x.ru===w.ru && x.jp===w.jp)) favorites.push(w);
  renderFav();
};
function renderFav(){
  $('#favList').innerHTML=favorites.map(w=>`<div>${w.ru} - ${w.jp}</div>`).join('');
}

/* ===== スライダー（ダブルタップ復帰） ===== */
function dblReset(el, def){
  let last=0;
  el.addEventListener('click',()=>{
    const now=Date.now();
    if(now-last<400){ el.value=def; }
    last=now;
  });
}
dblReset($('#rate'),1); dblReset($('#pitch'),1);

/* ===== TTS（iOS安定化） ===== */
function pickVoices(){
  const vs=speechSynthesis.getVoices();
  ruVoice = vs.find(v=>/ru/i.test(v.lang)||/russian/i.test(v.name))||null;
  jaVoice = vs.find(v=>/ja/i.test(v.lang)||/japanese/i.test(v.name))||null;
}
if('speechSynthesis' in window){
  pickVoices();
  speechSynthesis.onvoiceschanged = pickVoices;
}
document.addEventListener('click', function unlockOnce(){
  // 無音で解放
  const u=new SpeechSynthesisUtterance(' ');
  u.lang='ru-RU'; speechSynthesis.speak(u);
  ttsReady=true;
  document.removeEventListener('click', unlockOnce);
},{once:true});
function speakRU(){
  if(!data.length) return;
  const s=norm(data[idx].ru); if(!ttsReady||!s) return;
  const u=new SpeechSynthesisUtterance(s);
  u.lang='ru-RU'; if(ruVoice) u.voice=ruVoice;
  u.rate=parseFloat($('#rate').value)||1.0;
  u.pitch=parseFloat($('#pitch').value)||1.0;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
$('#speak').onclick = speakRU;  // 既存の「🔊 読み上げ」ボタンに接続
</script>

</body>
</html>