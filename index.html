<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ­ã‚·ã‚¢èªå˜èªå¸³</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .card { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:6px; }
    .row { margin:8px 0; }
    #drop { border:1px dashed #aaa; padding:8px; border-radius:6px; margin-top:6px; }
  </style>
</head>
<body>
  <h1>ãƒ­ã‚·ã‚¢èªå˜èªå¸³</h1>

  <!-- CSV æ“ä½œç”¨ -->
  <div class="row">
    <input type="file" id="csv" accept=".csv">
    <button id="btnFetchCsv">åŒæ¢±CSVã‚’èª­ã‚€</button>
    <div id="drop">CSVã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</div>
  </div>

  <!-- å˜èªè¡¨ç¤º -->
  <div class="card">
    <div id="ru" style="font-size:2em;font-weight:bold;"></div>
    <div id="jp" style="color:#555;"></div>
  </div>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="row">
    <button id="prev">â—€ å‰ã¸</button>
    <button id="next">æ¬¡ã¸ â–¶</button>
    <button id="speak">ğŸ”Š èª­ã¿ä¸Šã’</button>
  </div>

  <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
  <div class="row">
    <label>é€Ÿåº¦: <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1"></label>
    <label>å£°ã®é«˜ã•: <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1"></label>
  </div>

  <!-- ãŠæ°—ã«å…¥ã‚Š -->
  <div class="row">
    <button id="fav">â­ ãŠæ°—ã«å…¥ã‚Šè¿½åŠ </button>
    <div id="favList"></div>
  </div>

<script>
let data = [];   // {ru, jp}
let idx = 0;
let favorites = [];

/* ---- CSVå‡¦ç† ---- */
function norm(t){ return (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim(); }
async function parseCsvText(text){
  return new Promise(res=>{
    Papa.parse(text, {header:true, skipEmptyLines:true, complete:r=>res(
      r.data.map(x=>({ru:norm(x.ru), jp:norm(x.jp)})).filter(x=>x.ru&&x.jp)
    )});
  });
}

document.getElementById('csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});

const drop = document.getElementById('drop');
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#f7f7f7'; });
drop.addEventListener('dragleave', ()=> drop.style.background='');
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.style.background='';
  const f = e.dataTransfer.files[0]; if(!f) return;
  const txt = await f.text();
  const rows = await parseCsvText(txt);
  if(rows.length) loadData(rows, txt);
});

document.getElementById('btnFetchCsv').onclick = async ()=>{
  try{
    const resp = await fetch('./words.csv', {cache:'no-store'});
    if(!resp.ok) throw new Error(resp.status);
    const txt = await resp.text();
    const rows = await parseCsvText(txt);
    if(rows.length) loadData(rows, txt);
  }catch(e){ alert('words.csv ã‚’èª­ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }
};

function loadData(rows, raw){
  data = rows; idx=0;
  localStorage.setItem('lastCsv', raw);
  renderList(); show(0);
}

/* èµ·å‹•æ™‚ã«å‰å›CSVã‚’å¾©å…ƒ */
(async ()=>{
  const txt = localStorage.getItem('lastCsv');
  if(txt){
    const rows = await parseCsvText(txt);
    if(rows.length) { data=rows; show(0); renderList(); }
  }
})();

/* ---- å˜èªè¡¨ç¤º ---- */
function show(i){
  if(!data.length) return;
  idx = (i+data.length)%data.length;
  document.getElementById('ru').textContent = data[idx].ru;
  document.getElementById('jp').textContent = data[idx].jp;
}
document.getElementById('prev').onclick = ()=>show(idx-1);
document.getElementById('next').onclick = ()=>show(idx+1);

/* ---- èª­ã¿ä¸Šã’ ---- */
document.getElementById('speak').onclick = ()=>{
  if(!data.length) return;
  const u = new SpeechSynthesisUtterance(data[idx].ru);
  u.lang='ru-RU';
  u.rate = parseFloat(document.getElementById('rate').value);
  u.pitch= parseFloat(document.getElementById('pitch').value);
  speechSynthesis.cancel(); speechSynthesis.speak(u);
};

/* ---- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒªã‚»ãƒƒãƒˆ ---- */
function dblReset(el, def){
  let last=0;
  el.addEventListener('click',()=>{
    const now=Date.now();
    if(now-last<400){ el.value=def; }
    last=now;
  });
}
dblReset(document.getElementById('rate'), 1);
dblReset(document.getElementById('pitch'), 1);

/* ---- ãŠæ°—ã«å…¥ã‚Š ---- */
document.getElementById('fav').onclick=()=>{
  if(!data.length) return;
  const w = data[idx];
  if(!favorites.find(x=>x.ru===w.ru)){ favorites.push(w); renderFav(); }
};
function renderFav(){
  const box=document.getElementById('favList');
  box.innerHTML = favorites.map(w=>`<div>${w.ru} - ${w.jp}</div>`).join('');
}
function renderList(){ /* å°†æ¥æ‹¡å¼µç”¨ */ }
</script>
</body>
</html>