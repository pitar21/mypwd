<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãƒ­ã‚·ã‚¢èª å˜èªã‚«ãƒ¼ãƒ‰ï¼ˆæ®µéšè¡¨ç¤ºï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Arial;margin:16px}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .card{border:1px solid #ddd;border-radius:8px;padding:12px;margin:8px 0}
  .ru{font-size:28px;font-weight:700}
  .muted{color:#888}
  button{padding:8px 12px}
  input[type=range]{width:160px}
  #drop{border:1px dashed #aaa;padding:8px;border-radius:6px}
  .hidden{visibility:hidden}
</style>
</head>
<body>
<h1>ğŸ“– ãƒ­ã‚·ã‚¢èª å˜èªã‚«ãƒ¼ãƒ‰ï¼ˆæ®µéšè¡¨ç¤ºï¼‰</h1>

<!-- CSVæ“ä½œ -->
<div class="row">
  <input type="file" id="csv" accept=".csv" />
  <button id="btnFetchCsv">åŒæ¢±CSVã‚’èª­ã‚€</button>
  <div id="drop">CSVã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆãƒ˜ãƒƒãƒ€: ãƒ­ã‚·ã‚¢èª,æ—¥æœ¬èª,ç™ºéŸ³è¨˜å·,ã‚«ãƒŠï¼‰</div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ‰ãƒ»éŸ³å£° -->
<div class="row">
  <label><input type="checkbox" id="rand"> ãƒ©ãƒ³ãƒ€ãƒ </label>
  <button id="prev">â—€ å‰</button>
  <button id="next">æ¬¡ â–¶</button>
  <button id="revealNext">æ®µéšè¡¨ç¤º</button>
  <button id="resetReveal">éš ã™</button>
  <span class="muted">ï½œ RU Voice:</span>
  <select id="ruVoiceSel"><option>loadingâ€¦</option></select>
  <span class="muted">é€Ÿåº¦</span>
  <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1.0"><span id="rateVal">1.00</span>
  <span class="muted">ãƒ”ãƒƒãƒ</span>
  <input id="pitch" type="range" min="0.5" max="2.0" step="0.05" value="1.00"><span id="pitchVal">1.00</span>
</div>

<!-- ã‚«ãƒ¼ãƒ‰ -->
<div class="card" id="card">
  <div id="ru" class="ru">â€”</div>
  <div><span class="muted">æ„å‘³ï¼š</span><span id="jp" class="hidden">â€”</span></div>
  <div><span class="muted">IPAï¼š</span><span id="ipa" class="hidden">â€”</span></div>
  <div><span class="muted">ã‚«ãƒŠï¼š</span><span id="kana" class="hidden">â€”</span></div>
  <div class="row" style="margin-top:10px">
    <button id="speakRu">ğŸ”Š RUèª­ã¿ä¸Šã’</button>
  </div>
</div>

<script>
/* ===== çŠ¶æ…‹ ===== */
let rows = [
  {ru:'Ğ°Ñ€Ğ¼Ğ¸Ñ', jp:'è»', ipa:'[ËˆarmÊ²ÉªjÉ™]', kana:'ã‚¢ãƒ«ãƒŸãƒ¤'},
  {ru:'Ğ¿Ğ¾Ğ³Ğ¸Ğ±Ğ½ÑƒÑ‚ÑŒ', jp:'æˆ¦æ­»ã™ã‚‹', ipa:'[pÉËˆÉ¡Ê²ibnutÊ²]', kana:'ãƒ‘ã‚®ãƒ¼ãƒ–ãƒŒãƒ'},
  {ru:'Ğ´ĞµĞ¿ÑƒÑ‚Ğ°Ñ‚', jp:'è­°å“¡', ipa:'[dÊ²ÉªpÊŠËˆtat]', kana:'ãƒ‚ã‚§ãƒ—ã‚¿ãƒ¼ãƒˆ'}
]; // äºˆå‚™ãƒ‡ãƒ¼ã‚¿
let idx = 0;
let randMode = false;
let revealStep = 0; // 0:RUã®ã¿, 1:æ„å‘³, 2:IPA, 3:ã‚«ãƒŠ
let lastCsvRaw = localStorage.getItem('lastCsv4step') || null;

/* ===== è¦ç´  ===== */
const $ = s => document.querySelector(s);
const elRU = $('#ru'), elJP = $('#jp'), elIPA = $('#ipa'), elKana = $('#kana');

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const norm = t => (t||'').toString().replace(/\uFEFF/g,'').normalize('NFC').trim();
const sample = arr => arr[(Math.random()*arr.length)|0];
function bound(i,len){ return (i%len+len)%len; }

/* ===== è¡¨ç¤º ===== */
function applyReveal(){
  elJP.classList.toggle('hidden', revealStep < 1);
  elIPA.classList.toggle('hidden', revealStep < 2);
  elKana.classList.toggle('hidden', revealStep < 3);
}
function show(i){
  if(!rows.length){ elRU.textContent='ãƒ‡ãƒ¼ã‚¿ãªã—'; return; }
  idx = randMode ? rows.indexOf(sample(rows)) : bound(i, rows.length);
  const w = rows[idx];
  elRU.textContent  = w.ru || 'â€”';
  elJP.textContent  = w.jp || 'â€”';
  elIPA.textContent = w.ipa || 'â€”';
  elKana.textContent= w.kana || 'â€”';
  revealStep = 0;
  applyReveal();
}

/* ===== æ®µéšè¡¨ç¤º ===== */
$('#revealNext').onclick = ()=>{ if(revealStep < 3) revealStep++; applyReveal(); };
$('#resetReveal').onclick = ()=>{ revealStep = 0; applyReveal(); };

/* ===== ãƒŠãƒ“ ===== */
$('#prev').onclick = ()=> show(idx-1);
$('#next').onclick = ()=> show(idx+1);
$('#rand').onchange = e => { randMode = e.target.checked; };

/* ===== CSV èª­ã¿è¾¼ã¿ ===== */
async function parseCsvText(text){
  return new Promise(res=>{
    Papa.parse(text, {
      header:true, skipEmptyLines:true,
      complete:r=>res(
        r.data.map(x=>({
          ru:  norm(x['ãƒ­ã‚·ã‚¢èª']),
          jp:  norm(x['æ—¥æœ¬èª']),
          ipa: norm(x['ç™ºéŸ³è¨˜å·']),
          kana:norm(x['ã‚«ãƒŠ'])
        })).filter(x=>x.ru && (x.jp||x.ipa||x.kana))
      )
    });
  });
}
$('#csv').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const txt=await f.text(); const arr=await parseCsvText(txt);
  if(arr.length){ rows=arr; idx=0; localStorage.setItem('lastCsv4step', txt); show(0); }
});
const drop = $('#drop');
drop.addEventListener('dragover', e=>{e.preventDefault(); drop.style.background='#f7f7f7';});
drop.addEventListener('dragleave', ()=> drop.style.background='';);
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.style.background='';
  const f=e.dataTransfer.files[0]; if(!f) return;
  const txt=await f.text(); const arr=await parseCsvText(txt);
  if(arr.length){ rows=arr; idx=0; localStorage.setItem('lastCsv4step', txt); show(0); }
});
$('#btnFetchCsv').onclick = async ()=>{
  try{
    const resp=await fetch('./words.csv',{cache:'no-store'});
    if(!resp.ok) throw new Error();
    const txt=await resp.text(); const arr=await parseCsvText(txt);
    if(arr.length){ rows=arr; idx=0; localStorage.setItem('lastCsv4step', txt); show(0); }
  }catch{ alert('words.csv ã‚’èª­ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }
};
// å‰å›å¾©å…ƒ
(async()=>{
  if(lastCsvRaw){
    const arr=await parseCsvText(lastCsvRaw);
    if(arr.length){ rows=arr; idx=0; show(0); return; }
  }
  show(0);
})();

/* ===== TTSï¼ˆYuriå„ªå…ˆï¼‰ ===== */
let ruVoice = null, voicesCache = [];
function populateRuVoices(){
  voicesCache = speechSynthesis.getVoices();
  const ruCandidates = voicesCache.filter(v=>/ru/i.test(v.lang)||/russian/i.test(v.name));
  const sel = $('#ruVoiceSel'); sel.innerHTML='';
  ruCandidates.forEach(v=>{
    const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; sel.appendChild(o);
  });
  const y = ruCandidates.find(v=>/yuri/i.test(v.name));
  sel.value = y ? y.name : (ruCandidates[0]?.name||'');
  ruVoice = voicesCache.find(v=>v.name===sel.value)||null;
}
if('speechSynthesis' in window){
  populateRuVoices();
  speechSynthesis.onvoiceschanged = populateRuVoices;
}
$('#ruVoiceSel').onchange = e => { ruVoice = voicesCache.find(v=>v.name===e.target.value)||null; };

/* ===== TTS è§£æ”¾ãƒ»ç™ºå£° ===== */
let ttsReady=false;
document.addEventListener('click', function unlockOnce(){
  const u=new SpeechSynthesisUtterance(' '); u.lang='ru-RU'; speechSynthesis.speak(u);
  ttsReady=true; document.removeEventListener('click', unlockOnce);
},{once:true});

function speakRU(){
  if(!ttsReady) return;
  const text = norm(elRU.textContent); if(!text) return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang='ru-RU'; if(ruVoice) u.voice=ruVoice;
  u.rate=parseFloat($('#rate').value)||1.0;
  u.pitch=parseFloat($('#pitch').value)||1.0;
  speechSynthesis.speak(u);
}
$('#speakRu').onclick = speakRU;

/* ===== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤º ===== */
function bindSlider(id,valId){
  const el=$(id), out=$(valId);
  const upd=()=> out.textContent = Number(el.value).toFixed(2);
  el.addEventListener('input', upd); upd();
  // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§æ—¢å®šå€¤
  let last=0; el.addEventListener('click',()=>{const now=Date.now(); if(now-last<400){ el.value=id==='#rate'?1.0:1.0; upd(); } last=now;});
}
bindSlider('#rate','#rateVal');
bindSlider('#pitch','#pitchVal');
</script>
</body>
</html>
